name: "ClangTidy"

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3.1.0
    - name: Install
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 15 all
        ( cd /tmp
          git clone --depth 1 https://gitlab.com/libeigen/eigen.git
          mkdir eigen/build
          ( cd eigen/build
            cmake ..
            cmake --build . --parallel
            sudo cmake --install . ) )
        ( cd /tmp
          git clone --depth 1 https://github.com/fmtlib/fmt.git
          mkdir fmt/build
          ( cd fmt/build
            cmake ..
            cmake --build . --parallel
            sudo cmake --install . ) )
        ( cd /tmp
          git clone --depth 1 https://github.com/kokkos/mdspan.git
          mkdir mdspan/build
          ( cd mdspan/build
            cmake ..
            cmake --build . --parallel
            sudo cmake --install . ) )
        ( cd /tmp
          git clone --depth 1 https://github.com/kokkos/stdBLAS.git
          mkdir stdBLAS/build
          ( cd stdBLAS/build
            cmake ..
            cmake --build . --parallel
            sudo cmake --install . ) )
        ( cd /tmp
          git clone --depth 1 https://github.com/BobSteagall/wg21.git
          mkdir wg21/build
          ( cd wg21/build
            cmake ..
            sudo cmake --install . ) )
        ( cd /tmp
          git clone --depth 1 https://github.com/google/benchmark.git
          mkdir benchmark/build
          ( cd benchmark/build
            cmake -DBENCHMARK_DOWNLOAD_DEPENDENCIES=on -DCMAKE_BUILD_TYPE=Release ..
            cmake --build . --config Release --parallel 4
            sudo cmake --install . ) )
    - name: Verify
      run: |
        clang-tidy \
          `find . -iname "*.hpp" -o -iname "*.cpp"` \
          -header-filter=.* -system-headers=0 --warnings-as-errors=* -- \
          -x c++ -Wall -Wextra -pedantic -std=c++2b \
          -Iinclude -Ibenchmark/include -Isupport -I/usr/local/include/eigen3 \
          -DFMT_HEADER_ONLY -stdlib=libc++ -lfmt
