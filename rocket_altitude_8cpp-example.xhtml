<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kalman: rocket_altitude.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Kalman<span id="projectnumber">&#160;0.1.0</span>
   </div>
   <div id="projectbrief">Kalman Filter for C++</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.xhtml');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('rocket_altitude_8cpp-example.xhtml',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle"><div class="title">rocket_altitude.cpp</div></div>
</div><!--header-->
<div class="contents">
<p >Estimating the Rocket Altitude</p><dl class="section copyright"><dt>Copyright</dt><dd>This example is transcribed from KalmanFilter.NET copyright Alex Becker.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a href="https://www.kalmanfilter.net/multiExamples.html#ex10">https://www.kalmanfilter.net/multiExamples.html#ex10</a></dd></dl>
<p>In this example, we will estimate the altitude of a rocket. The rocket is equipped with an onboard altimeter that provides altitude measurements. In addition to an altimeter, the rocket is equipped with an accelerometer that measures the rocket acceleration. The accelerometer serves as a control input to the Kalman Filter. We assume constant acceleration dynamics. Accelerometers don't sense gravity. An accelerometer at rest on a table would measure 1g upwards, while accelerometers in free fall will measure zero. Thus, we need to subtract the gravitational acceleration constant g from each accelerometer measurement. The accelerometer measurement at time step n is: an = a − g + ϵ where:</p><ul>
<li>a is the actual acceleration of the object (the second derivative of the object position).</li>
<li>g is the gravitational acceleration constant; g = -9.8 m.s^-2.</li>
<li>ϵ is the accelerometer measurement error. In this example, we have a control variable u, which is based on the accelerometer measurement. The system state xn is defined by: xn = [ pn vn ] where: pn is the rocket altitude at time n. vn is the rocket velocity at time n. Let us assume a rocket boosting vertically with constant acceleration. The rocket is equipped with an altimeter that provides altitude measurements and an accelerometer that serves as a control input.</li>
<li>The measurements period: Δt = 0.25s</li>
<li>The rocket acceleration: a= 30 m.s^-2</li>
<li>The altimeter measurement error standard deviation: σxm = 20m</li>
<li>The accelerometer measurement error standard deviation: ϵ = 0.1 m.s^-2</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="kalman__eigen_8hpp.xhtml">fcarouge/kalman_eigen.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacefcarouge_1_1sample.xhtml">fcarouge::sample</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">[[maybe_unused]] <span class="keyword">auto</span> <a id="a0" name="a0"></a><a class="code hl_variable" href="namespacefcarouge_1_1sample_1_1anonymous__namespace_02rocket__altitude_8cpp_03.xhtml#a63759677e8cdcc8efbbc101504f93f97">rocket_altitude</a>{ [] {</div>
<div class="line">  <span class="comment">// A 2x1x1 filter, constant acceleration dynamic model, no control, step time.</span></div>
<div class="line">  <span class="keyword">using</span> <a id="a1" name="a1"></a><a class="code hl_typedef" href="namespacefcarouge_1_1eigen.xhtml#af57be964591879e808a2567fe7d4e107">kalman</a> = eigen::kalman&lt;double, 2, 1, 1, std::chrono::milliseconds&gt;;</div>
<div class="line">  <a class="code hl_typedef" href="namespacefcarouge_1_1eigen.xhtml#af57be964591879e808a2567fe7d4e107">kalman</a> k;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialization</span></div>
<div class="line">  <span class="comment">// We don&#39;t know the rocket location; we will set initial position and</span></div>
<div class="line">  <span class="comment">// velocity to 0.</span></div>
<div class="line">  k.x(0, 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Since our initial state vector is a guess, we will set a very high estimate</span></div>
<div class="line">  <span class="comment">// uncertainty. The high estimate uncertainty results in high Kalman gain,</span></div>
<div class="line">  <span class="comment">// giving a high weight to the measurement.</span></div>
<div class="line">  k.p(<a id="a2" name="a2"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#ac7fadbd41c0b8cf294b5484f48b864c1">kalman::estimate_uncertainty</a>{ { 500, 0 }, { 0, 500 } });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Prediction</span></div>
<div class="line">  <span class="comment">// We will assume a discrete noise model - the noise is different at each time</span></div>
<div class="line">  <span class="comment">// period, but it is constant between time periods. In our previous example,</span></div>
<div class="line">  <span class="comment">// we used the system&#39;s random variance in acceleration σ^2 as a multiplier of</span></div>
<div class="line">  <span class="comment">// the process noise matrix. But here, we have an accelerometer that measures</span></div>
<div class="line">  <span class="comment">// the system random acceleration. The accelerometer error v is much lower</span></div>
<div class="line">  <span class="comment">// than system&#39;s random acceleration, therefore we use ϵ^2 as a multiplier of</span></div>
<div class="line">  <span class="comment">// the process noise matrix. This makes our estimation uncertainty much lower!</span></div>
<div class="line">  k.q([](<span class="keyword">const</span> std::chrono::milliseconds &amp;delta_time) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> dt{ std::chrono::duration&lt;double&gt;(delta_time).count() };</div>
<div class="line">    <span class="keywordflow">return</span> <a id="a3" name="a3"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a42caad834524117c55661c08b61de506">kalman::process_uncertainty</a>{</div>
<div class="line">      { 0.1 * 0.1 * dt * dt * dt * dt / 4, 0.1 * 0.1 * dt * dt * dt / 2 },</div>
<div class="line">      { 0.1 * 0.1 * dt * dt * dt / 2, 0.1 * 0.1 * dt * dt }</div>
<div class="line">    };</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// The state transition matrix F would be:</span></div>
<div class="line">  k.f([](<span class="keyword">const</span> std::chrono::milliseconds &amp;delta_time) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> dt{ std::chrono::duration&lt;double&gt;(delta_time).count() };</div>
<div class="line">    <span class="keywordflow">return</span> <a id="a4" name="a4"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a1d7d5f5f6e79c6b9b2f0a5fec61058f8">kalman::state_transition</a>{ { 1, dt }, { 0, 1 } };</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// The control matrix G would be:</span></div>
<div class="line">  k.g([](<span class="keyword">const</span> std::chrono::milliseconds &amp;delta_time) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> dt{ std::chrono::duration&lt;double&gt;(delta_time).count() };</div>
<div class="line">    <span class="keywordflow">return</span> <a id="a5" name="a5"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a0f5c80bcca633d47c8e24db7896aec93">kalman::input_control</a>{ 0.0313, dt };</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// We also don&#39;t know what the rocket acceleration is, but we can assume that</span></div>
<div class="line">  <span class="comment">// it&#39;s greater than zero. Let&#39;s assume: u0 = g</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> gravitational_acceleration{ -9.8 }; <span class="comment">// m.s^-2</span></div>
<div class="line">  <span class="keyword">const</span> std::chrono::milliseconds delta_time{ 250 };</div>
<div class="line">  k.predict(delta_time, gravitational_acceleration);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Measure and Update</span></div>
<div class="line">  <span class="comment">// The dimension of zn is 1x1 and the dimension of xn is 2x1, so the dimension</span></div>
<div class="line">  <span class="comment">// of the observation matrix H will be 1x2.</span></div>
<div class="line">  k.h(1, 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// For the sake of the example simplicity, we will assume a constant</span></div>
<div class="line">  <span class="comment">// measurement uncertainty: R1 = R2...Rn-1 = Rn = R.</span></div>
<div class="line">  k.r(400);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// The measurement values: z1 = -32.40, u1 = 39.72.</span></div>
<div class="line">  k.update(-32.40);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// And so on, run a step of the filter, predicting and updating, every</span></div>
<div class="line">  <span class="comment">// measurements period: Δt = 250ms. The period is constant but passed as</span></div>
<div class="line">  <span class="comment">// variable for the example. The lambda helper shows how to simplify the</span></div>
<div class="line">  <span class="comment">// filter step call.</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> step{ [&amp;k](<span class="keyword">const</span> <span class="keyword">auto</span> &amp;...args) {</div>
<div class="line">    k.template operator()&lt;<span class="keywordtype">double</span>&gt;(args...);</div>
<div class="line">  } };</div>
<div class="line"> </div>
<div class="line">  step(delta_time, 39.72, -11.1);</div>
<div class="line">  step(delta_time, 40.02, 18);</div>
<div class="line">  step(delta_time, 39.97, 22.9);</div>
<div class="line">  step(delta_time, 39.81, 19.5);</div>
<div class="line">  step(delta_time, 39.75, 28.5);</div>
<div class="line">  step(delta_time, 39.6, 46.5);</div>
<div class="line">  step(delta_time, 39.77, 68.9);</div>
<div class="line">  step(delta_time, 39.83, 48.2);</div>
<div class="line">  step(delta_time, 39.73, 56.1);</div>
<div class="line">  step(delta_time, 39.87, 90.5);</div>
<div class="line">  step(delta_time, 39.81, 104.9);</div>
<div class="line">  step(delta_time, 39.92, 140.9);</div>
<div class="line">  step(delta_time, 39.78, 148);</div>
<div class="line">  step(delta_time, 39.98, 187.6);</div>
<div class="line">  step(delta_time, 39.76, 209.2);</div>
<div class="line">  step(delta_time, 39.86, 244.6);</div>
<div class="line">  step(delta_time, 39.61, 276.4);</div>
<div class="line">  step(delta_time, 39.86, 323.5);</div>
<div class="line">  step(delta_time, 39.74, 357.3);</div>
<div class="line">  step(delta_time, 39.87, 357.4);</div>
<div class="line">  step(delta_time, 39.63, 398.3);</div>
<div class="line">  step(delta_time, 39.67, 446.7);</div>
<div class="line">  step(delta_time, 39.96, 465.1);</div>
<div class="line">  step(delta_time, 39.8, 529.4);</div>
<div class="line">  step(delta_time, 39.89, 570.4);</div>
<div class="line">  step(delta_time, 39.85, 636.8);</div>
<div class="line">  step(delta_time, 39.9, 693.3);</div>
<div class="line">  step(delta_time, 39.81, 707.3);</div>
<div class="line">  step(delta_time, 39.81, 707.3);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// The Kalman gain for altitude converged to 0.12, which means that the</span></div>
<div class="line">  <span class="comment">// estimation weight is much higher than the measurement weight.</span></div>
<div class="line">  assert(49.3 - 0.01 &lt; k.p()(0, 0) &amp;&amp; k.p()(0, 0) &lt; 49.3 + 0.0001 &amp;&amp;</div>
<div class="line">         <span class="stringliteral">&quot;At this point, the altitude uncertainty px = 49.3, which means that &quot;</span></div>
<div class="line">         <span class="stringliteral">&quot;the standard deviation of the prediction is square root of 49.3: &quot;</span></div>
<div class="line">         <span class="stringliteral">&quot;7.02m (remember that the standard deviation of the measurement is &quot;</span></div>
<div class="line">         <span class="stringliteral">&quot;20m).&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  k.predict(delta_time, 39.68);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// At the beginning, the estimated altitude is influenced by measurements and</span></div>
<div class="line">  <span class="comment">// it is not aligned well with the true rocket altitude, since the</span></div>
<div class="line">  <span class="comment">// measurements are very noisy. But as the Kalman gain converges, the noisy</span></div>
<div class="line">  <span class="comment">// measurement has less influence and the estimated altitude is well aligned</span></div>
<div class="line">  <span class="comment">// with the true altitude. In this example we don&#39;t have any maneuvers that</span></div>
<div class="line">  <span class="comment">// cause acceleration changes, but if we had, the control input</span></div>
<div class="line">  <span class="comment">// (accelerometer) would update the state extrapolation equation.</span></div>
<div class="line">  assert(831.5 - 0.001 &lt; k.x()(0) &amp;&amp; k.x()(0) &lt; 831.5 + 54 &amp;&amp;</div>
<div class="line">         222.94 - 0.001 &lt; k.x()(1) &amp;&amp; k.x()(1) &lt; 222.94 + 40);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}() };</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace</span></div>
<div class="line">} <span class="comment">// namespace fcarouge::sample</span></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_a0f5c80bcca633d47c8e24db7896aec93"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#a0f5c80bcca633d47c8e24db7896aec93">fcarouge::kalman::input_control</a></div><div class="ttdeci">typename implementation::input_control input_control</div><div class="ttdoc">Type of the control transition matrix G.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00164">kalman.hpp:164</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_a1d7d5f5f6e79c6b9b2f0a5fec61058f8"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#a1d7d5f5f6e79c6b9b2f0a5fec61058f8">fcarouge::kalman::state_transition</a></div><div class="ttdeci">typename implementation::state_transition state_transition</div><div class="ttdoc">Type of the state transition matrix F.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00154">kalman.hpp:154</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_a42caad834524117c55661c08b61de506"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#a42caad834524117c55661c08b61de506">fcarouge::kalman::process_uncertainty</a></div><div class="ttdeci">typename implementation::process_uncertainty process_uncertainty</div><div class="ttdoc">Type of the process noise correlated variance matrix Q.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00146">kalman.hpp:146</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_ac7fadbd41c0b8cf294b5484f48b864c1"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#ac7fadbd41c0b8cf294b5484f48b864c1">fcarouge::kalman::estimate_uncertainty</a></div><div class="ttdeci">typename implementation::estimate_uncertainty estimate_uncertainty</div><div class="ttdoc">Type of the estimated correlated variance matrix P.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00143">kalman.hpp:143</a></div></div>
<div class="ttc" id="akalman__eigen_8hpp_xhtml"><div class="ttname"><a href="kalman__eigen_8hpp.xhtml">kalman_eigen.hpp</a></div><div class="ttdoc">Kalman operation for Eigen 3 types.</div></div>
<div class="ttc" id="anamespacefcarouge_1_1eigen_xhtml_af57be964591879e808a2567fe7d4e107"><div class="ttname"><a href="namespacefcarouge_1_1eigen.xhtml#af57be964591879e808a2567fe7d4e107">fcarouge::eigen::kalman</a></div><div class="ttdeci">fcarouge::kalman&lt; Type, Eigen::Vector&lt; Type, State &gt;, Eigen::Vector&lt; Type, Output &gt;, Eigen::Vector&lt; Type, Input &gt;, internal::transpose, internal::symmetrize, internal::divide, internal::identity, std::multiplies&lt; void &gt;, PredictionArguments... &gt; kalman</div><div class="ttdoc">Eigen-based Kalman filter.</div><div class="ttdef"><b>Definition:</b> <a href="kalman__eigen_8hpp_source.xhtml#l00070">kalman_eigen.hpp:75</a></div></div>
<div class="ttc" id="anamespacefcarouge_1_1sample_1_1anonymous__namespace_02rocket__altitude_8cpp_03_xhtml_a63759677e8cdcc8efbbc101504f93f97"><div class="ttname"><a href="namespacefcarouge_1_1sample_1_1anonymous__namespace_02rocket__altitude_8cpp_03.xhtml#a63759677e8cdcc8efbbc101504f93f97">fcarouge::sample::anonymous_namespace{rocket_altitude.cpp}::rocket_altitude</a></div><div class="ttdeci">auto rocket_altitude</div><div class="ttdef"><b>Definition:</b> <a href="rocket__altitude_8cpp_source.xhtml#l00044">rocket_altitude.cpp:44</a></div></div>
<div class="ttc" id="anamespacefcarouge_1_1sample_xhtml"><div class="ttname"><a href="namespacefcarouge_1_1sample.xhtml">fcarouge::sample</a></div><div class="ttdoc">Examples, tutorials, demonstrators of the library.</div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat May 21 2022 21:29:27 for Kalman by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
