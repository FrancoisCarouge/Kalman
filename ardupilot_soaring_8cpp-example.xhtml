<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kalman: ardupilot_soaring.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Kalman<span id="projectnumber">&#160;0.1.0</span>
   </div>
   <div id="projectbrief">Kalman Filter for C++</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.xhtml');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('ardupilot_soaring_8cpp-example.xhtml',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle"><div class="title">ardupilot_soaring.cpp</div></div>
</div><!--header-->
<div class="contents">
<p >ArduPilot Plane Soaring</p><dl class="section copyright"><dt>Copyright</dt><dd>This example is transcribed from the ArduPilot Soaring Plane copyright ArduPilot Dev Team.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a href="https://ardupilot.org/plane/docs/soaring.html">https://ardupilot.org/plane/docs/soaring.html</a> </dd>
<dd>
<a href="https://arxiv.org/abs/1802.08215">https://arxiv.org/abs/1802.08215</a></dd></dl>
<p>The autonomous soaring functionality in ArduPilot allows the plane to respond to rising air current in order to extend endurance and gain altitude with minimal use of the motor. The full technical description is available in S. Tabor, I. Guilliard, A. Kolobov. ArduSoar: an Open-Source Thermalling Controller for Resource-Constrained Autopilots. International Conference on Intelligent Robots and Systems (IROS), 2018. Estimating the parameters of a Wharington et al thermal model state X: [W, R, x, y] with the speed or strength W [m.s^-1] at the center of the thermal of radius R [m] with the center distance x north of the sUAV and y east of the sUAV.</p>
<dl class="todo"><dt><b><a class="el" href="todo.xhtml#_todo000027">Todo:</a></b></dt><dd>Add a data set and assert for correctness of results. </dd></dl>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="kalman__eigen_8hpp.xhtml">fcarouge/kalman_eigen.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacefcarouge_1_1sample.xhtml">fcarouge::sample</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">[[maybe_unused]] <span class="keyword">auto</span> <a id="a0" name="a0"></a><a class="code hl_variable" href="namespacefcarouge_1_1sample_1_1anonymous__namespace_02ardupilot__soaring_8cpp_03.xhtml#a7dc03328a16eccbebf58a471b5a3de1b">ardupilot_soaring</a>{ [] {</div>
<div class="line">  <span class="comment">// 4x1 extended filter with additional parameter for prediction: driftX [m],</span></div>
<div class="line">  <span class="comment">// driftY [m]. Constant time step.</span></div>
<div class="line">  <span class="keyword">using</span> <a id="a1" name="a1"></a><a class="code hl_typedef" href="namespacefcarouge_1_1eigen.xhtml#a19baaa3fe4523729db807408c3771dc3">kalman</a> = eigen::kalman&lt;float, 4, 1, 0, std::tuple&lt;float, float&gt;,</div>
<div class="line">                               std::tuple&lt;float, float&gt;&gt;;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_typedef" href="namespacefcarouge_1_1eigen.xhtml#a19baaa3fe4523729db807408c3771dc3">kalman</a> k;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialization</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> trigger_strength{ 1 / 4.06 };</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> thermal_radius{ 80 };</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> thermal_position_x{ 0 };</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> thermal_position_y{ 0 };</div>
<div class="line">  k.x(trigger_strength, thermal_radius, thermal_position_x, thermal_position_y);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> strength_covariance{ 0.0049 };</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> radius_covariance{ 400 };</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> position_covariance{ 400 }; <span class="comment">// For both positions x and y.</span></div>
<div class="line">  k.p(<a id="a2" name="a2"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#af8d6f479798f305c207fdc67c07a2b5a">kalman::estimate_uncertainty</a>{ { strength_covariance, 0, 0, 0 },</div>
<div class="line">                                    { 0, radius_covariance, 0, 0 },</div>
<div class="line">                                    { 0, 0, position_covariance, 0 },</div>
<div class="line">                                    { 0, 0, 0, position_covariance } });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// No process dynamics: F = ∂f/∂X = I4 Default.</span></div>
<div class="line"> </div>
<div class="line">  k.transition([](<span class="keyword">const</span> <a id="a3" name="a3"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a546e3b8fcd1880d3dd9a2b57c939d442">kalman::state</a> &amp;x, <span class="keyword">const</span> <span class="keywordtype">float</span> &amp;drift_x,</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">float</span> &amp;drift_y) -&gt; <a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a546e3b8fcd1880d3dd9a2b57c939d442">kalman::state</a> {</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a546e3b8fcd1880d3dd9a2b57c939d442">kalman::state</a> drifts{ 0, 0, -drift_x, -drift_y };</div>
<div class="line">    <span class="keywordflow">return</span> x + drifts;</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> strength_noise{ std::pow(0.001f, 2.f) };</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> distance_noise{ std::pow(0.03f, 2.f) };</div>
<div class="line">  k.q(<a id="a4" name="a4"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#af3c5d0d70a3c0426a0802fdd85e7eeef">kalman::process_uncertainty</a>{ { strength_noise, 0, 0, 0 },</div>
<div class="line">                                   { 0, distance_noise, 0, 0 },</div>
<div class="line">                                   { 0, 0, distance_noise, 0 },</div>
<div class="line">                                   { 0, 0, 0, distance_noise } });</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> measure_noise{ std::pow(0.45f, 2.f) };</div>
<div class="line">  k.r(measure_noise);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Observation Z: [w] vertical air velocity w at the aircraft’s</span></div>
<div class="line">  <span class="comment">// position w.r.t. the thermal center [m.s^-1].</span></div>
<div class="line">  k.observation([](<span class="keyword">const</span> <a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a546e3b8fcd1880d3dd9a2b57c939d442">kalman::state</a> &amp;x, <span class="keyword">const</span> <span class="keywordtype">float</span> &amp;position_x,</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">float</span> &amp;position_y) -&gt; <a id="a5" name="a5"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a6199ad3f51d6a22231e698c5ca44c03f">kalman::output</a> {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> exp{ std::exp(</div>
<div class="line">        -(std::pow(x(2) - position_x, 2.f) + std::pow(x(3) - position_y, 2.f)) /</div>
<div class="line">        std::pow(x(1), 2.f)) };</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a6199ad3f51d6a22231e698c5ca44c03f">kalman::output</a>{ x(0) * exp };</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// See the ArduSoar paper for the equation for H = ∂h/∂X:</span></div>
<div class="line">  k.h([](<span class="keyword">const</span> <a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a546e3b8fcd1880d3dd9a2b57c939d442">kalman::state</a> &amp;x, <span class="keyword">const</span> <span class="keywordtype">float</span> &amp;position_x,</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">float</span> &amp;position_y) -&gt; <a id="a6" name="a6"></a><a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a791753b3b6d9d97a1772736d4e545507">kalman::output_model</a> {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> exp{ std::exp(</div>
<div class="line">        -(std::pow(x(2) - position_x, 2.f) + std::pow(x(3) - position_y, 2.f)) /</div>
<div class="line">        std::pow(x(1), 2.f)) };</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_typedef" href="classfcarouge_1_1kalman.xhtml#a791753b3b6d9d97a1772736d4e545507">kalman::output_model</a> h{</div>
<div class="line">      exp,</div>
<div class="line">      2 * x(0) *</div>
<div class="line">          ((std::pow(x(2) - position_x, 2.f) +</div>
<div class="line">            std::pow(x(3) - position_y, 2.f)) /</div>
<div class="line">           std::pow(x(1), 3.f)) *</div>
<div class="line">          exp,</div>
<div class="line">      -2 * (x(0) * (x(2) - position_x) / std::pow(x(1), 2.f)) * exp,</div>
<div class="line">      -2 * (x(0) * (x(3) - position_y) / std::pow(x(1), 2.f)) * exp</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordflow">return</span> h;</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Measure and Update</span></div>
<div class="line">  <span class="keywordtype">float</span> drift_x{ 0 };</div>
<div class="line">  <span class="keywordtype">float</span> drift_y{ 0 };</div>
<div class="line">  k.predict(drift_x, drift_y);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">float</span> variometer{ 0 };</div>
<div class="line">  <span class="keywordtype">float</span> position_x{ 0 };</div>
<div class="line">  <span class="keywordtype">float</span> position_y{ 0 };</div>
<div class="line">  k.update(variometer, position_x, position_y);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Or so on.</span></div>
<div class="line">  k(drift_x, drift_y, position_x, position_y, variometer);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}() };</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace</span></div>
<div class="line">} <span class="comment">// namespace fcarouge::sample</span></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_a546e3b8fcd1880d3dd9a2b57c939d442"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#a546e3b8fcd1880d3dd9a2b57c939d442">fcarouge::kalman::state</a></div><div class="ttdeci">typename implementation::state state</div><div class="ttdoc">Type of the state estimate column vector X.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00208">kalman.hpp:208</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_a6199ad3f51d6a22231e698c5ca44c03f"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#a6199ad3f51d6a22231e698c5ca44c03f">fcarouge::kalman::output</a></div><div class="ttdeci">typename implementation::output output</div><div class="ttdoc">Type of the observation column vector Z.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00213">kalman.hpp:213</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_a791753b3b6d9d97a1772736d4e545507"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#a791753b3b6d9d97a1772736d4e545507">fcarouge::kalman::output_model</a></div><div class="ttdeci">typename implementation::output_model output_model</div><div class="ttdoc">Type of the observation transition matrix H.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00239">kalman.hpp:239</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_af3c5d0d70a3c0426a0802fdd85e7eeef"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#af3c5d0d70a3c0426a0802fdd85e7eeef">fcarouge::kalman::process_uncertainty</a></div><div class="ttdeci">typename implementation::process_uncertainty process_uncertainty</div><div class="ttdoc">Type of the process noise correlated variance matrix Q.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00226">kalman.hpp:226</a></div></div>
<div class="ttc" id="aclassfcarouge_1_1kalman_xhtml_af8d6f479798f305c207fdc67c07a2b5a"><div class="ttname"><a href="classfcarouge_1_1kalman.xhtml#af8d6f479798f305c207fdc67c07a2b5a">fcarouge::kalman::estimate_uncertainty</a></div><div class="ttdeci">typename implementation::estimate_uncertainty estimate_uncertainty</div><div class="ttdoc">Type of the estimated correlated variance matrix P.</div><div class="ttdef"><b>Definition:</b> <a href="kalman_8hpp_source.xhtml#l00223">kalman.hpp:223</a></div></div>
<div class="ttc" id="akalman__eigen_8hpp_xhtml"><div class="ttname"><a href="kalman__eigen_8hpp.xhtml">kalman_eigen.hpp</a></div><div class="ttdoc">Kalman operation for Eigen 3 types.</div></div>
<div class="ttc" id="anamespacefcarouge_1_1eigen_xhtml_a19baaa3fe4523729db807408c3771dc3"><div class="ttname"><a href="namespacefcarouge_1_1eigen.xhtml#a19baaa3fe4523729db807408c3771dc3">fcarouge::eigen::kalman</a></div><div class="ttdeci">fcarouge::kalman&lt; Type, State, Output, Input, transpose, symmetrize, divide, identity_matrix, UpdateTypes, PredictionTypes &gt; kalman</div><div class="ttdoc">Eigen-based Kalman filter.</div><div class="ttdef"><b>Definition:</b> <a href="kalman__eigen_8hpp_source.xhtml#l00074">kalman_eigen.hpp:76</a></div></div>
<div class="ttc" id="anamespacefcarouge_1_1sample_1_1anonymous__namespace_02ardupilot__soaring_8cpp_03_xhtml_a7dc03328a16eccbebf58a471b5a3de1b"><div class="ttname"><a href="namespacefcarouge_1_1sample_1_1anonymous__namespace_02ardupilot__soaring_8cpp_03.xhtml#a7dc03328a16eccbebf58a471b5a3de1b">fcarouge::sample::anonymous_namespace{ardupilot_soaring.cpp}::ardupilot_soaring</a></div><div class="ttdeci">auto ardupilot_soaring</div><div class="ttdef"><b>Definition:</b> <a href="ardupilot__soaring_8cpp_source.xhtml#l00032">ardupilot_soaring.cpp:32</a></div></div>
<div class="ttc" id="anamespacefcarouge_1_1sample_xhtml"><div class="ttname"><a href="namespacefcarouge_1_1sample.xhtml">fcarouge::sample</a></div><div class="ttdoc">Examples, tutorials, demonstrators of the library.</div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Aug 9 2022 02:24:34 for Kalman by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
